<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NZ Address & Site Parameter Tool</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }

    .search-wrap { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    #addressInput { width:min(650px,100%); padding:10px; border:1px solid #ccc; border-radius:6px; }
    #useMyLocationBtn { padding:10px; border:1px solid #aaa; border-radius:6px; background:#fff; cursor:pointer; }

    #map { height: 420px; width: 100%; border:1px solid #ccc; border-radius:6px; margin-bottom:12px; }
    #coords { font-weight: bold; margin-bottom: 12px; }

    .option-block { padding:15px; border:1px solid #ddd; border-radius:6px; background:#fafafa; margin-bottom:14px; }
    .row { margin-bottom:14px; }
    .row label { font-weight:bold; display:block; margin-bottom:6px; }

    .option-buttons button {
      padding:8px 12px; margin:4px;
      border:1px solid #aaa; border-radius:4px;
      background:#fff; cursor:pointer;
    }
    .option-buttons button.selected { background:#007bff; color:#fff; border-color:#007bff; }

    .status { padding:10px; border:1px solid #ddd; border-radius:6px; background:#fff; }
    .muted { color:#666; }

    table { width:100%; border-collapse:collapse; margin-top:10px; background:#fff; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; vertical-align:top; }
    th { background:#f3f3f3; }
    .pill { display:inline-block; padding:3px 8px; border:1px solid #ddd; border-radius:999px; margin:2px; background:#f8f8f8; }
  </style>
</head>

<body>

<h2>NZ Address & Site Parameter Tool</h2>

<div class="search-wrap">
  <input id="addressInput" placeholder="Search address (NZ only)" />
  <button id="useMyLocationBtn" type="button">Use my location</button>
</div>

<div id="map"></div>
<div id="coords">Choose a location (search or click the map)</div>

<div class="option-block">
  <h3>Design Parameters</h3>

  <!-- Site Class kept (not used in this workflow filtering) -->
  <div class="row">
    <label>Site Class</label>
    <div class="option-buttons" id="siteClassOptions">
      <button type="button" data-value="I">I</button>
      <button type="button" data-value="II">II</button>
      <button type="button" data-value="III">III</button>
      <button type="button" data-value="IV">IV</button>
      <button type="button" data-value="V">V</button>
      <button type="button" data-value="VI">VI</button>
    </div>
  </div>

  <div class="row">
    <label>Importance Level</label>
    <div class="option-buttons" id="importanceLevelOptions">
      <button type="button" data-value="1">1</button>
      <button type="button" data-value="2">2</button>
      <button type="button" data-value="3">3</button>
      <button type="button" data-value="4">4</button>
    </div>
  </div>

  <div class="row">
    <label>Design Working Life</label>
    <div class="option-buttons" id="workingLifeOptions">
      <button type="button" data-value="construction">Construction equipment</button>
      <button type="button" data-value="lt6months">Less than 6 months</button>
      <button type="button" data-value="5">5 years</button>
      <button type="button" data-value="25">25 years</button>
      <button type="button" data-value="50">50 years</button>
      <button type="button" data-value="100">100 years or more</button>
    </div>
  </div>
</div>

<div class="status">
  <div><strong>Status:</strong> <span id="statusText">Waiting for input…</span></div>
  <div id="stepInfo" class="muted"></div>
  <div id="results"></div>
</div>

<script>
  /**************************************************************
   * CONFIG
   **************************************************************/
  const SHEET_ID = "1f34jZQUy7Jw4BZOP8xwj6DgXXvwDPnxbGhGkhUadULg";
  const SHEET1_NAME = "Sheet1";
  const SHEET2_NAME = "Sheet2";

  // Sheet1: Column A = Lat, Column B = Lng
  const SHEET1_LAT_COL_INDEX = 0; // A
  const SHEET1_LNG_COL_INDEX = 1; // B

  // ✅ IMPORTANT: Set this to the column index in Sheet1 that contains APOE
  // If APOE is column C, keep 2. If APOE is column D, set 3, etc.
  const SHEET1_APOE_COL_INDEX = 2;

  // Sheet2 mapping per your workflow:
  // A = WorkingLife, B = ImportanceLevel, C/D/E = APOE strings to use for filtering
  const SHEET2_WORKINGLIFE_COL_INDEX = 0;     // A
  const SHEET2_IMPORTANCE_COL_INDEX  = 1;     // B
  const SHEET2_STRING_COLS = [2, 3, 4];       // C, D, E

  // How many nearest Sheet1 rows to keep before filtering by strings
  const SHEET1_NEAREST_COUNT = 25;

  /**************************************************************
   * STATE
   **************************************************************/
  let map, marker, autocomplete;
  let selectedLat = null, selectedLng = null;

  let selectedSiteClass = "";          // not used in filtering per your workflow
  let selectedImportanceLevel = "";
  let selectedWorkingLife = "";

  // Step 1 result: nearest rows from Sheet1
  let nearestSheet1Rows = []; // array of {distKm, row, lat, lng, apoe}

  // Step 2 result: strings from Sheet2 C/D/E for chosen inputs
  let sheet2Strings = []; // array of strings

  /**************************************************************
   * HELPERS
   **************************************************************/
  function setStatus(msg){ document.getElementById("statusText").textContent = msg; }
  function setInfo(html){ document.getElementById("stepInfo").innerHTML = html || ""; }

  function normalize(v){
    if (v === null || v === undefined) return "";
    return String(v).trim();
  }

  function eqLoose(a, b){
    // Handles "1" vs 1 and case differences.
    const sa = normalize(a);
    const sb = normalize(b);
    if (sa === sb) return true;
    const na = Number(sa), nb = Number(sb);
    if (!Number.isNaN(na) && !Number.isNaN(nb) && na === nb) return true;
    return sa.toLowerCase() === sb.toLowerCase();
  }

  function haversineKm(lat1,lng1,lat2,lng2){
    const R=6371, toRad=d=>d*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
    const a=Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
            Math.sin(dLng/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  function setMarker(lat,lng){
    const pos = {lat, lng};
    if(marker) marker.setMap(null);
    marker = new google.maps.Marker({ map, position: pos });
    map.panTo(pos);
  }

  /**************************************************************
   * GOOGLE SHEETS (GVIZ)
   **************************************************************/
  function gvizUrl(sheetName, query){
    const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
    const params = new URLSearchParams();
    params.set("sheet", sheetName);
    params.set("tq", query);
    return `${base}?${params.toString()}`;
  }

  async function fetchSheetAs2DArray(sheetName, query){
    const url = gvizUrl(sheetName, query);
    const res = await fetch(url);
    const text = await res.text();

    const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    const data = JSON.parse(jsonText);

    const cols = data.table.cols.length;
    const rows = data.table.rows || [];

    return rows.map(r => {
      const arr = new Array(cols).fill(null);
      (r.c || []).forEach((cell, i) => { arr[i] = cell ? cell.v : null; });
      return arr;
    });
  }

  /**************************************************************
   * STEP 1:
   * user picks location -> match nearest rows in Sheet1 (A,B)
   **************************************************************/
  async function step1_findNearestSheet1Rows(){
    if (!Number.isFinite(selectedLat) || !Number.isFinite(selectedLng)) return;

    setStatus("Step 1: Finding nearest rows in Sheet1…");

    const rows = await fetchSheetAs2DArray(SHEET1_NAME, "select *");
    if (!rows.length) {
      nearestSheet1Rows = [];
      setStatus("No rows found in Sheet1 (check sharing/tab name).");
      return;
    }

    const scored = [];
    for (const row of rows) {
      const lat = parseFloat(row[SHEET1_LAT_COL_INDEX]);
      const lng = parseFloat(row[SHEET1_LNG_COL_INDEX]);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

      const distKm = haversineKm(selectedLat, selectedLng, lat, lng);
      scored.push({
        distKm,
        lat,
        lng,
        apoe: row[SHEET1_APOE_COL_INDEX],
        row
      });
    }

    scored.sort((a,b) => a.distKm - b.distKm);
    nearestSheet1Rows = scored.slice(0, SHEET1_NEAREST_COUNT);

    setStatus("Step 1 complete.");
  }

  /**************************************************************
   * STEP 2:
   * user selects importance + working life -> match Sheet2 A & B
   * -> store strings from Sheet2 C/D/E
   **************************************************************/
  async function step2_getStringsFromSheet2(){
    sheet2Strings = [];

    if (!selectedWorkingLife || !selectedImportanceLevel) return;

    setStatus("Step 2: Looking up selected options in Sheet2…");

    const sheet2 = await fetchSheetAs2DArray(SHEET2_NAME, "select A,B,C,D,E");
    if (!sheet2.length) {
      setStatus("Sheet2 empty / not accessible.");
      return;
    }

    // Skip header row if it looks like headers
    const headerish =
      normalize(sheet2[0][SHEET2_WORKINGLIFE_COL_INDEX]).toLowerCase().includes("working") ||
      normalize(sheet2[0][SHEET2_IMPORTANCE_COL_INDEX]).toLowerCase().includes("importance");
    const dataRows = headerish ? sheet2.slice(1) : sheet2;

    // Find matching row in Sheet2 where A=WorkingLife AND B=Importance
    const matchRow = dataRows.find(r =>
      eqLoose(r[SHEET2_WORKINGLIFE_COL_INDEX], selectedWorkingLife) &&
      eqLoose(r[SHEET2_IMPORTANCE_COL_INDEX], selectedImportanceLevel)
    );

    if (!matchRow) {
      sheet2Strings = [];
      setStatus("No matching row in Sheet2 for selected options.");
      return;
    }

    // Collect strings from C/D/E (ignore blanks)
    sheet2Strings = SHEET2_STRING_COLS
      .map(i => normalize(matchRow[i]))
      .filter(v => v.length > 0);

    setStatus("Step 2 complete.");
  }

  /**************************************************************
   * STEP 3:
   * Filter the nearest Sheet1 rows to only those whose APOE matches
   * ANY of the strings from Sheet2 C/D/E.
   **************************************************************/
  function step3_filterNearestSheet1Rows(){
    if (!nearestSheet1Rows.length) return [];
    if (!sheet2Strings.length) return [];

    const stringSet = new Set(sheet2Strings.map(s => s.toLowerCase()));

    return nearestSheet1Rows.filter(item => {
      const apoe = normalize(item.apoe).toLowerCase();
      return apoe && stringSet.has(apoe);
    });
  }

  /**************************************************************
   * RENDER
   **************************************************************/
  function render(filteredRows){
    const resultsEl = document.getElementById("results");

    const infoBits = [];
    if (Number.isFinite(selectedLat) && Number.isFinite(selectedLng)) {
      infoBits.push(`Location: <b>${selectedLat.toFixed(5)}, ${selectedLng.toFixed(5)}</b>`);
    }
    if (selectedWorkingLife) infoBits.push(`Working Life: <b>${selectedWorkingLife}</b>`);
    if (selectedImportanceLevel) infoBits.push(`Importance: <b>${selectedImportanceLevel}</b>`);
    if (sheet2Strings.length) {
      infoBits.push(`Sheet2 strings (C/D/E): ${sheet2Strings.map(s => `<span class="pill">${s}</span>`).join("")}`);
    } else if (selectedWorkingLife && selectedImportanceLevel) {
      infoBits.push(`<span class="muted">Sheet2 strings: (none found)</span>`);
    }
    infoBits.push(`<span class="muted">Nearest Sheet1 rows considered: ${nearestSheet1Rows.length}</span>`);

    setInfo(infoBits.join("<br>"));

    if (!Number.isFinite(selectedLat) || !Number.isFinite(selectedLng)) {
      resultsEl.innerHTML = `<div class="muted">Pick a location first.</div>`;
      return;
    }
    if (!selectedWorkingLife || !selectedImportanceLevel) {
      resultsEl.innerHTML = `<div class="muted">Select Working Life and Importance Level.</div>`;
      return;
    }
    if (!sheet2Strings.length) {
      resultsEl.innerHTML = `<div class="muted">No Sheet2 strings found for that selection (check Sheet2 A/B values match your button values).</div>`;
      return;
    }
    if (!filteredRows.length) {
      resultsEl.innerHTML = `<div><strong>No matches found</strong></div>
      <div class="muted">None of the nearest Sheet1 rows had APOE matching Sheet2 C/D/E strings.</div>`;
      return;
    }

    // Render a simple table. Columns shown: distance, lat, lng, apoe.
    resultsEl.innerHTML =
      `<div><strong>Filtered Sheet1 rows (APOE matches Sheet2 C/D/E):</strong></div>
       <table>
         <thead>
           <tr>
             <th>Dist (km)</th>
             <th>Lat</th>
             <th>Lng</th>
             <th>APOE</th>
           </tr>
         </thead>
         <tbody>
           ${filteredRows.map(r => `
             <tr>
               <td>${r.distKm.toFixed(3)}</td>
               <td>${r.lat.toFixed(5)}</td>
               <td>${r.lng.toFixed(5)}</td>
               <td>${normalize(r.apoe)}</td>
             </tr>
           `).join("")}
         </tbody>
       </table>`;
  }

  /**************************************************************
   * RECALC PIPELINE
   **************************************************************/
  async function recalc(){
    try {
      // Step 1 needs location
      await step1_findNearestSheet1Rows();

      // Step 2 needs user selections
      await step2_getStringsFromSheet2();

      // Step 3 filters
      const filtered = step3_filterNearestSheet1Rows();

      setStatus("Done.");
      render(filtered);
    } catch (err) {
      console.error(err);
      setStatus("Error (check console).");
      document.getElementById("results").innerHTML = `<div class="muted">Error occurred. See console.</div>`;
    }
  }

  /**************************************************************
   * BUTTON WIRING
   **************************************************************/
  function wireSingleSelectButtons(containerId, setter){
    const buttons = document.querySelectorAll(`#${containerId} button`);
    buttons.forEach(btn => {
      btn.addEventListener("click", async () => {
        buttons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        setter(btn.dataset.value);
        await recalc();
      });
    });
  }

  /**************************************************************
   * MAP + AUTOCOMPLETE
   **************************************************************/
  function initMap(){
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: -41.2865, lng: 174.7762 },
      zoom: 6
    });

    map.addListener("click", async (e) => {
      selectedLat = e.latLng.lat();
      selectedLng = e.latLng.lng();
      setMarker(selectedLat, selectedLng);

      document.getElementById("coords").textContent =
        `Lat: ${selectedLat.toFixed(5)}, Lng: ${selectedLng.toFixed(5)}`;

      await recalc();
    });

    autocomplete = new google.maps.places.Autocomplete(
      document.getElementById("addressInput"),
      { componentRestrictions: { country: "nz" } }
    );

    autocomplete.addListener("place_changed", async () => {
      const place = autocomplete.getPlace();
      if (!place.geometry || !place.geometry.location) {
        setStatus("No geometry for that address. Try another.");
        return;
      }

      selectedLat = place.geometry.location.lat();
      selectedLng = place.geometry.location.lng();
      setMarker(selectedLat, selectedLng);
      map.setZoom(14);

      document.getElementById("coords").textContent =
        `Lat: ${selectedLat.toFixed(5)}, Lng: ${selectedLng.toFixed(5)} — ${place.formatted_address || ""}`;

      await recalc();
    });

    document.getElementById("useMyLocationBtn").addEventListener("click", () => {
      if (!navigator.geolocation) {
        setStatus("Geolocation not supported.");
        return;
      }
      navigator.geolocation.getCurrentPosition(async (pos) => {
        selectedLat = pos.coords.latitude;
        selectedLng = pos.coords.longitude;
        setMarker(selectedLat, selectedLng);
        map.setZoom(14);

        document.getElementById("coords").textContent =
          `Lat: ${selectedLat.toFixed(5)}, Lng: ${selectedLng.toFixed(5)}`;

        await recalc();
      }, () => setStatus("Could not get your location (permission denied?)."));
    });

    // Buttons (Site Class is not used in the filtering but kept for future calcs)
    wireSingleSelectButtons("siteClassOptions", v => selectedSiteClass = v);
    wireSingleSelectButtons("importanceLevelOptions", v => selectedImportanceLevel = v);
    wireSingleSelectButtons("workingLifeOptions", v => selectedWorkingLife = v);

    setStatus("Ready. Choose location + options.");
  }

  window.initMap = initMap;
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC671lrEe82CVe7kS6yCebRsF3GIGrOmLw&callback=initMap&libraries=places"
  async defer></script>

</body>
</html>
