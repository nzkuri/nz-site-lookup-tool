<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TS1170.5 site parameter finder</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 20px; }

    #pageTitle { text-align:center; margin: 0 0 16px 0; }

    .content-wrap{ width:100%; max-width:1400px; margin:0 auto; }

    .search-wrap { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; width:100%; }
    #addressInput { flex: 1 1 520px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; }
    #useMyLocationBtn { padding:10px; border:1px solid #aaa; border-radius:6px; background:#fff; cursor:pointer; }

    #coords { font-weight:bold; margin-bottom:12px; }

    .main-grid { display:flex; gap:16px; align-items:stretch; width:100%; }
    .left-panel { flex: 0 0 520px; max-width:520px; width:100%; }
    .right-panel { flex: 1 1 auto; min-width:320px; display:flex; }
    @media (max-width: 980px){
      .main-grid { flex-direction: column; }
      .left-panel { max-width:100%; flex-basis:auto; }
      .right-panel { width:100%; }
    }

    .option-block{
      padding:15px;
      border:1px solid #ddd;
      border-radius:6px;
      background:#fafafa;
      width:100%;
    }
    .row { margin-bottom:14px; }
    .row label { font-weight:bold; display:block; margin-bottom:6px; }

    .option-buttons button{
      padding:8px 12px; margin:4px;
      border:1px solid #aaa; border-radius:4px;
      background:#fff; cursor:pointer;
      transition: background .15s, color .15s, border-color .15s;
    }
    .option-buttons button.selected{
      background:#007bff; color:#fff; border-color:#007bff;
    }

    #map{
      width:100%;
      min-height:280px;
      border:1px solid #ccc;
      border-radius:6px;
      flex: 1 1 auto;
    }

    /* Results */
    .results-wrap{
      width:100%;
      margin-top:16px;
      padding:12px;
      border:1px solid #ddd;
      border-radius:8px;
      background:#fff;
      position:relative;
    }
    #roundedCoordsBar{
      display:none;
      font-weight:700;
      color:#666;
      margin-bottom:10px;
    }
    #specialNotice{
      display:none;
      padding:12px;
      border:1px solid #ddd;
      border-radius:8px;
      background:#fafafa;
      font-weight:800;
      margin-bottom:10px;
    }

    #tablesGrid{ display:grid; gap:12px; width:100%; }
    .table-card{
      width:100%;
      overflow-x:auto;
      border:1px solid #eee;
      border-radius:8px;
      padding:8px;
      background:#fff;
    }
    .sc-table { width:100%; border-collapse:collapse; background:#fff; font-size:14px; }
    .sc-table th, .sc-table td { border:2px solid #000; padding:8px; text-align:center; vertical-align:middle; white-space:nowrap; }
    .sc-table thead th { font-weight:700; }
    .sc-table .left-head { width:220px; text-align:left; }
    .sc-table .left-cell { text-align:left; font-weight:700; }
    .sc-table .subhead { font-weight:700; }

    .loading-overlay{
      position:absolute; inset:0;
      background: rgba(255,255,255,0.85);
      display:none;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      z-index:2;
      font-weight:700;
    }
    .loading-overlay.show{ display:flex; }

    /* Coming soon box */
    .coming-soon-box{
      margin-top: 14px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f5f5f5;
      color: #666;
      font-weight: 700;
      text-align: center;
      opacity: 0.8;
    }

    /* Suggestions collapsible */
    details.suggestions-details{
      margin-top:18px;
      width:100%;
      border:1px solid #ddd;
      border-radius:8px;
      background:#fafafa;
      padding:0;
      overflow:hidden;
    }
    details.suggestions-details > summary{
      list-style:none;
      cursor:pointer;
      padding:14px;
      font-weight:700;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    details.suggestions-details > summary::-webkit-details-marker { display:none; }
    .suggestions-body{ padding:14px; border-top:1px solid #ddd; }
    #suggestionText{
      width:100%;
      min-height:110px;
      resize:vertical;
      padding:10px;
      border:1px solid #ccc;
      border-radius:6px;
      font-family:inherit;
      font-size:14px;
    }
    #submitSuggestionBtn{
      display:inline-block;
      margin-top:10px;
      padding:10px 14px;
      border:1px solid #aaa;
      border-radius:6px;
      background:#fff;
      cursor:pointer;
    }
    #suggestionMsg{ margin-top:8px; color:#666; }

    /* Debug panel */
    details.debug-details{
      margin-top: 12px;
      width: 100%;
      border: 1px dashed #ccc;
      border-radius: 8px;
      background: #fafafa;
      overflow: hidden;
    }
    details.debug-details > summary{
      list-style:none;
      cursor:pointer;
      padding:10px 12px;
      font-weight:700;
      user-select:none;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    details.debug-details > summary::-webkit-details-marker{ display:none; }
    .debug-body{ padding:10px 12px; border-top:1px dashed #ccc; }
    pre#debugPre{
      margin:0;
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      background:#fff;
      border:1px solid #eee;
      border-radius:6px;
      padding:10px;
      max-height: 280px;
      overflow:auto;
    }

    /* Consent modals */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:18px;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width:min(820px, 100%);
      background:#fff;
      border-radius:12px;
      border:1px solid #ddd;
      box-shadow:0 20px 60px rgba(0,0,0,0.25);
      overflow:hidden;
      position:relative;
    }
    .modal-header{
      padding:14px 16px;
      border-bottom:1px solid #eee;
      font-weight:800;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .modal-title{ font-size:16px; }
    .modal-body{
      padding:16px;
      max-height:min(60vh, 520px);
      overflow:auto;
      white-space:pre-line;
      line-height:1.35;
      font-size:14px;
    }
    .modal-footer{
      padding:14px 16px;
      border-top:1px solid #eee;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn{
      padding:10px 14px;
      border:1px solid #aaa;
      border-radius:8px;
      background:#fff;
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{ background:#007bff; border-color:#007bff; color:#fff; }
    .btn.danger{ border-color:#c00; color:#c00; }
    .close-x{
      width:34px; height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid #ddd;
      border-radius:8px;
      background:#fff;
      cursor:pointer;
      font-weight:900;
      line-height:1;
    }

    body.consent-locked .content-wrap{
      pointer-events:none;
      user-select:none;
    }
  </style>
</head>

<body class="consent-locked">
  <h2 id="pageTitle">TS1170.5 site parameter finder</h2>

  <div class="content-wrap">
    <div class="search-wrap">
      <input id="addressInput" placeholder="Search address (NZ only)" />
      <button id="useMyLocationBtn" type="button">Use my location</button>
    </div>

    <div id="coords">Choose a location (search or click the map)</div>

    <div class="main-grid">
      <div class="left-panel">
        <div class="option-block" id="designInputsBlock">
          <h3>Design Inputs</h3>

          <div class="row">
            <label>Site Class</label>
            <div class="option-buttons" id="siteClassOptions">
              <button type="button" data-value="I">I</button>
              <button type="button" data-value="II">II</button>
              <button type="button" data-value="III">III</button>
              <button type="button" data-value="IV">IV</button>
              <button type="button" data-value="V">V</button>
              <button type="button" data-value="VI">VI</button>
            </div>
          </div>

          <div class="row">
            <label>Importance Level</label>
            <div class="option-buttons" id="importanceLevelOptions">
              <button type="button" data-value="1">1</button>
              <button type="button" data-value="2">2</button>
              <button type="button" data-value="3">3</button>
              <button type="button" data-value="4">4</button>
            </div>
          </div>

          <div class="row" style="margin-bottom:0;">
            <label>Design Working Life</label>
            <div class="option-buttons" id="workingLifeOptions">
              <button type="button" data-value="construction">Construction equipment</button>
              <button type="button" data-value="lt6months">Less than 6 months</button>
              <button type="button" data-value="5">5 years</button>
              <button type="button" data-value="25">25 years</button>
              <button type="button" data-value="50">50 years</button>
              <button type="button" data-value="100">100 years or more</button>
            </div>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <div id="map"></div>
      </div>
    </div>

    <div class="results-wrap">
      <div class="loading-overlay" id="loadingOverlay">Loading…</div>
      <div id="roundedCoordsBar"></div>
      <div id="specialNotice"></div>
      <div id="tablesGrid"></div>

      <details class="debug-details" id="debugDetails">
        <summary>
          <span>Debug: Last lookup response</span>
          <span id="debugSymbol">+</span>
        </summary>
        <div class="debug-body">
          <pre id="debugPre">{}</pre>
        </div>
      </details>
    </div>

    <div class="coming-soon-box">Horizontal Design Action Coefficient - Coming Soon</div>

    <details class="suggestions-details" id="suggestionsDetails">
      <summary>
        <span>Suggestions</span>
        <span id="suggestionsSymbol" style="font-weight:700; color:#666;">+</span>
      </summary>
      <div class="suggestions-body">
        <textarea id="suggestionText" placeholder="Got an idea to improve this tool? Drop it here…"></textarea>
        <div>
          <button id="submitSuggestionBtn" type="button">Submit</button>
        </div>
        <div id="suggestionMsg"></div>
      </div>
    </details>
  </div>

  <!-- Consent Modal -->
  <div class="modal-backdrop show" id="consentModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="consentTitle">
      <div class="modal-header">
        <div class="modal-title" id="consentTitle">Notice & Consent</div>
        <div style="width:34px;"></div>
      </div>
      <div class="modal-body">
TS1170.5 Site Parameter Finder is made available without charge and in good faith. It is agreed by the user that no liability for its use, applicability or accuracy is accepted by the author. Professional care and judgement must be exercised, with relevant design knowledge and skill applied by the use.
This site uses essential cookies and collects approximate location data (country/region/city) for analytics and improvement.
      </div>
      <div class="modal-footer">
        <button class="btn primary" id="btnAccept">Accept & Continue</button>
        <button class="btn danger" id="btnExit">Exit</button>
        <button class="btn" id="btnLearnMore">Learn more</button>
      </div>
    </div>
  </div>

  <!-- Learn More Modal -->
  <div class="modal-backdrop" id="learnMoreModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="learnMoreTitle">
      <div class="modal-header">
        <div class="modal-title" id="learnMoreTitle">Location Information</div>
        <button class="close-x" id="btnLearnMoreClose" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
Location Information (NZ Privacy Act 2020)
This website collects approximate location information (such as country, region, or city) derived from your IP address.
This information is collected in accordance with the Privacy Act 2020 (New Zealand) and is used for legitimate purposes, including:
• Understanding how the tool is used across different regions
• Improving performance and reliability
• Anonymous usage analytics
We do not collect precise location data, do not track individuals, and do not use location information to identify you.
Location information is handled in aggregated form and may be processed by trusted third-party service providers solely for the purposes described above.
________________________________________
Key Privacy Principles 
In line with the NZ Privacy Act:
• We only collect information that is necessary for the operation and improvement of the tool
• Information is collected lawfully and fairly
• Data is used only for the purposes it was collected
• Reasonable steps are taken to protect the information
________________________________________
Your Rights
Under the Privacy Act 2020, you have the right to:
• Request access to personal information held about you
• Request correction of that information, if applicable
Because only approximate, non-identifying location data is collected, there is generally no personal information that can be linked to an individual user.
      </div>
    </div>
  </div>

  <script>
    /**************************************************************
     * CONFIG (REQUIRED)
     **************************************************************/
    const WEB_APP_URL = "PASTE_YOUR_WEB_APP_URL_HERE"; // must end in /exec
    const GOOGLE_MAPS_KEY = "AIzaSyC671lrEe82CVe7kS6yCebRsF3GIGrOmLw";
    const GEO_URL = "/geo";
  </script>

  <script>
    let map, marker, autocomplete;
    let selectedLat = null, selectedLng = null;
    let selectedSiteClass = "";
    let selectedImportanceLevel = "";
    let selectedWorkingLife = "";

    let recalcToken = 0;
    const pageStartMs = Date.now();

    const DEBUG_ENABLED = true;
    function setDebug(obj){
      if (!DEBUG_ENABLED) return;
      const pre = document.getElementById("debugPre");
      if (pre) pre.textContent = JSON.stringify(obj || {}, null, 2);
    }

    function hasAllInputs(){
      return Number.isFinite(selectedLat) &&
             Number.isFinite(selectedLng) &&
             !!selectedSiteClass &&
             !!selectedWorkingLife &&
             !!selectedImportanceLevel;
    }

    function showLoading(show){
      document.getElementById("loadingOverlay").classList.toggle("show", !!show);
    }

    function hideSpecialNotice(){
      const n = document.getElementById("specialNotice");
      n.style.display = "none";
      n.textContent = "";
    }

    function showSpecialNotice(text){
      const n = document.getElementById("specialNotice");
      n.textContent = text;
      n.style.display = "block";
    }

    function clearResults(){
      document.getElementById("tablesGrid").innerHTML = "";
      const rounded = document.getElementById("roundedCoordsBar");
      rounded.style.display = "none";
      rounded.textContent = "";
      hideSpecialNotice();
    }

    function applyTablesGridColumns(n){
      const grid = document.getElementById("tablesGrid");
      if (n === 4) grid.style.gridTemplateColumns = "repeat(2, 1fr)";
      else if (n === 3) grid.style.gridTemplateColumns = "repeat(3, 1fr)";
      else if (n === 2) grid.style.gridTemplateColumns = "repeat(2, 1fr)";
      else grid.style.gridTemplateColumns = "repeat(1, 1fr)";
    }

    function buildTableHTML(t){
      return `
        <table class="sc-table">
          <thead>
            <tr>
              <th class="left-head">${t.title || ""}</th>
              <th colspan="3">Site Class ${t.siteClass || ""}</th>
            </tr>
            <tr>
              <th class="subhead left-head">apoe</th>
              <th class="subhead">PGA</th>
              <th class="subhead">Sa,s</th>
              <th class="subhead">Tc</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="left-cell">${t.apoe || "(APOE blank)"}</td>
              <td>${t.pga ?? ""}</td>
              <td>${t.sa ?? ""}</td>
              <td>${t.tc ?? ""}</td>
            </tr>
          </tbody>
        </table>
      `;
    }

    async function postWebApp(payloadObj){
      const body = new URLSearchParams();
      body.set("payload", JSON.stringify(payloadObj));

      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body: body.toString()
      });

      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch(e){ throw new Error("Non-JSON response: " + text.slice(0,200)); }
      if (!res.ok || json.ok === false) throw new Error(json.error || ("HTTP " + res.status));
      return json;
    }

    // GEO cache
    let GEO_CACHE = null;
    let GEO_CACHE_TS = 0;
    const GEO_CACHE_TTL_MS = 10 * 60 * 1000;

    async function getGeoCoarse(){
      const now = Date.now();
      if (GEO_CACHE && (now - GEO_CACHE_TS) < GEO_CACHE_TTL_MS) return GEO_CACHE;

      try{
        const res = await fetch(GEO_URL, { cache: "no-store" });
        const txt = await res.text();
        const obj = JSON.parse(txt);
        GEO_CACHE = {
          geoCountry: obj.geoCountry || obj.country || "",
          geoRegion:  obj.geoRegion  || obj.region  || "",
          geoCity:    obj.geoCity    || obj.city    || ""
        };
      } catch(e){
        GEO_CACHE = { geoCountry:"", geoRegion:"", geoCity:"" };
      }
      GEO_CACHE_TS = now;
      return GEO_CACHE;
    }

    function analyticsBase(){
      const rLat = Number.isFinite(selectedLat) ? (Math.round(selectedLat*10)/10).toFixed(1) : "";
      const rLng = Number.isFinite(selectedLng) ? (Math.round(selectedLng*10)/10).toFixed(1) : "";
      return {
        siteClass: selectedSiteClass || "",
        importanceLevel: selectedImportanceLevel || "",
        workingLife: selectedWorkingLife || "",
        roundedLatLng: (rLat && rLng) ? `${rLat},${rLng}` : "",
        page: location.pathname || "",
        userAgent: navigator.userAgent || ""
      };
    }

    function logEvent(name, extra = {}){
      (async () => {
        try{
          const geo = await getGeoCoarse();
          await postWebApp(Object.assign(
            { mode: "analytics", event: String(name || "") },
            analyticsBase(),
            geo,
            extra,
            { tsClient: new Date().toISOString() }
          ));
        } catch(e){}
      })();
    }

    window.addEventListener("load", () => logEvent("page_load", {}));
    window.addEventListener("beforeunload", () => {
      const seconds = Math.max(0, Math.round((Date.now() - pageStartMs)/1000));
      logEvent("page_exit", { timeOnPageSeconds: seconds });
    });

    async function recalc(){
      const myToken = ++recalcToken;

      clearResults();
      if (!hasAllInputs()) return;

      showLoading(true);

      try{
        const data = await postWebApp({
          mode: "lookup",
          lat: selectedLat,
          lng: selectedLng,
          siteClass: selectedSiteClass,
          importanceLevel: selectedImportanceLevel,
          workingLife: selectedWorkingLife
        });

        if (myToken !== recalcToken) return;

        setDebug(data);

        const tables = Array.isArray(data.tables) ? data.tables : [];
        const apoes = tables.map(t => t.apoe).filter(Boolean);

        if (!tables.length) {
          showSpecialNotice("Lookup returned 0 tables for this selection.");
          logEvent("results_generated", { displayedTablesCount: 0 });
          return;
        }

        if (tables.length === 1) {
          showSpecialNotice(`Lookup returned 1 table (APOE: ${apoes[0] || "unknown"}).`);
        } else {
          hideSpecialNotice();
        }

        const roundedBar = document.getElementById("roundedCoordsBar");
        roundedBar.innerHTML = `Rounded (1dp) match key: <b>${data.roundedKey || ""}</b>`;
        roundedBar.style.display = "";

        applyTablesGridColumns(tables.length);

        document.getElementById("tablesGrid").innerHTML = tables
          .map(t => `<div class="table-card">${buildTableHTML(t)}</div>`)
          .join("");

        logEvent("results_generated", { displayedTablesCount: tables.length });

      } catch(err){
        console.error(err);
        setDebug({ error: String(err) });
        showSpecialNotice("Lookup failed. Check WEB_APP_URL / deployment. See Debug panel.");
        logEvent("error", { message: String(err) });
      } finally {
        if (myToken === recalcToken) showLoading(false);
      }
    }

    function syncMapHeightToOptionBlock(){
      const block = document.getElementById("designInputsBlock");
      const mapEl = document.getElementById("map");
      if (!block || !mapEl) return;

      const h = Math.max(280, Math.round(block.getBoundingClientRect().height));
      mapEl.style.height = h + "px";

      if (window.google && google.maps && map) {
        google.maps.event.trigger(map, "resize");
        if (marker) map.panTo(marker.getPosition());
      }
    }

    function setupHeightSync(){
      const block = document.getElementById("designInputsBlock");
      if (!block) return;

      requestAnimationFrame(syncMapHeightToOptionBlock);

      if ("ResizeObserver" in window) {
        const ro = new ResizeObserver(() => syncMapHeightToOptionBlock());
        ro.observe(block);
      }
      window.addEventListener("resize", syncMapHeightToOptionBlock);
    }

    function wireSingleSelectButtons(containerId, setter, buttonType){
      const buttons = document.querySelectorAll(`#${containerId} button`);
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          setter(btn.dataset.value);
          logEvent("button_click", { buttonType, buttonValue: btn.dataset.value });
          syncMapHeightToOptionBlock();
          recalc();
        });
      });
    }

    function getVisitorId(){
      const key = "nz_tool_visitor_id";
      let id = localStorage.getItem(key);
      if (!id) {
        id = (crypto.randomUUID) ? ("v_" + crypto.randomUUID()) : ("v_" + Date.now());
        localStorage.setItem(key, id);
      }
      return id;
    }

    function wireSuggestions(){
      const textarea = document.getElementById("suggestionText");
      const btn = document.getElementById("submitSuggestionBtn");
      const msg = document.getElementById("suggestionMsg");

      btn.addEventListener("click", async () => {
        const text = (textarea.value || "").trim();
        msg.textContent = "";
        if (!text) { msg.textContent = "Please type a suggestion first."; return; }

        btn.disabled = true;
        btn.textContent = "Submitting…";

        try{
          await postWebApp({
            mode: "suggestion",
            suggestionText: text,
            visitorId: getVisitorId(),
            page: location.pathname || ""
          });
          textarea.value = "";
          msg.textContent = "Thanks — suggestion submitted.";
          logEvent("suggestion_submitted", {});
        } catch(err){
          console.error(err);
          msg.textContent = "Submit failed (check console).";
          logEvent("suggestion_failed", { message: String(err) });
        } finally {
          btn.disabled = false;
          btn.textContent = "Submit";
        }
      });
    }

    // Consent
    const CONSENT_SESSION_KEY = "ts1170_5_consent_session_ok_v1";
    function showConsentModal(){
      document.getElementById("consentModal").classList.add("show");
      document.getElementById("learnMoreModal").classList.remove("show");
      document.body.classList.add("consent-locked");
    }
    function hideConsentModal(){
      document.getElementById("consentModal").classList.remove("show");
      document.getElementById("learnMoreModal").classList.remove("show");
      document.body.classList.remove("consent-locked");
    }
    function initConsent(){
      const suggestions = document.getElementById("suggestionsDetails");
      const sSym = document.getElementById("suggestionsSymbol");
      if (suggestions) suggestions.open = false;
      if (suggestions && sSym){
        suggestions.addEventListener("toggle", () => sSym.textContent = suggestions.open ? "−" : "+");
      }

      const dbg = document.getElementById("debugDetails");
      const dSym = document.getElementById("debugSymbol");
      if (dbg) dbg.open = false;
      if (dbg && dSym){
        dbg.addEventListener("toggle", () => dSym.textContent = dbg.open ? "−" : "+");
      }

      const accepted = sessionStorage.getItem(CONSENT_SESSION_KEY) === "true";
      if (!accepted) showConsentModal();
      else hideConsentModal();

      document.getElementById("btnAccept").addEventListener("click", () => {
        sessionStorage.setItem(CONSENT_SESSION_KEY, "true");
        hideConsentModal();
        logEvent("consent_accepted", {});
      });

      document.getElementById("btnExit").addEventListener("click", () => {
        window.location.href = "https://www.standards.govt.nz/shop/snz-ts-1170-52025";
      });

      document.getElementById("btnLearnMore").addEventListener("click", () => {
        document.getElementById("consentModal").classList.remove("show");
        document.getElementById("learnMoreModal").classList.add("show");
      });

      document.getElementById("btnLearnMoreClose").addEventListener("click", () => {
        document.getElementById("learnMoreModal").classList.remove("show");
        document.getElementById("consentModal").classList.add("show");
      });
    }

    // Maps
    function setMarker(lat,lng){
      const pos = { lat, lng };
      if (marker) marker.setMap(null);
      marker = new google.maps.Marker({ map, position: pos });
      map.panTo(pos);
    }

    function initMap(){
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -41.2865, lng: 174.7762 },
        zoom: 6
      });

      setupHeightSync();
      syncMapHeightToOptionBlock();

      map.addListener("click", (e) => {
        selectedLat = e.latLng.lat();
        selectedLng = e.latLng.lng();
        setMarker(selectedLat, selectedLng);
        document.getElementById("coords").textContent =
          `Lat: ${selectedLat.toFixed(5)}, Lng: ${selectedLng.toFixed(5)}`;
        logEvent("location_selected", { locationMethod: "map_click", lat: selectedLat, lng: selectedLng });
        recalc();
      });

      autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("addressInput"),
        { componentRestrictions: { country: "nz" } }
      );

      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry || !place.geometry.location) return;

        selectedLat = place.geometry.location.lat();
        selectedLng = place.geometry.location.lng();
        setMarker(selectedLat, selectedLng);
        map.setZoom(14);

        document.getElementById("coords").textContent =
          `Lat: ${selectedLat.toFixed(5)}, Lng: ${selectedLng.toFixed(5)} — ${place.formatted_address || ""}`;

        logEvent("location_selected", {
          locationMethod: "address_search",
          address: place.formatted_address || "",
          lat: selectedLat,
          lng: selectedLng
        });

        recalc();
      });

      document.getElementById("useMyLocationBtn").addEventListener("click", () => {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition((pos) => {
          selectedLat = pos.coords.latitude;
          selectedLng = pos.coords.longitude;
          setMarker(selectedLat, selectedLng);
          map.setZoom(14);
          document.getElementById("coords").textContent =
            `Lat: ${selectedLat.toFixed(5)}, Lng: ${selectedLng.toFixed(5)}`;
          logEvent("location_selected", { locationMethod: "my_location", lat: selectedLat, lng: selectedLng });
          recalc();
        }, () => logEvent("location_failed", { locationMethod: "my_location", reason: "permission_denied" }));
      });

      wireSingleSelectButtons("siteClassOptions", v => selectedSiteClass = v, "site_class");
      wireSingleSelectButtons("importanceLevelOptions", v => selectedImportanceLevel = v, "importance_level");
      wireSingleSelectButtons("workingLifeOptions", v => selectedWorkingLife = v, "working_life");

      wireSuggestions();
      clearResults();
      showLoading(false);
    }

    window.addEventListener("load", initConsent);
    window.initMap = initMap;

    (function loadGoogleMaps(){
      const s = document.createElement("script");
      s.src = "https://maps.googleapis.com/maps/api/js"
        + "?key=" + encodeURIComponent(GOOGLE_MAPS_KEY)
        + "&callback=initMap"
        + "&libraries=places";
      s.async = true;
      s.defer = true;
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
