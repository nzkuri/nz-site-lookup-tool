<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NZ Address & Site Parameter Tool</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }

    .search-wrap { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    #addressInput { width:min(650px,100%); padding:10px; border:1px solid #ccc; border-radius:6px; }
    #useMyLocationBtn { padding:10px; border:1px solid #aaa; border-radius:6px; background:#fff; cursor:pointer; }

    #map { height: 420px; width: 100%; border:1px solid #ccc; border-radius:6px; margin-bottom:12px; }
    #coords { font-weight: bold; margin-bottom: 12px; }

    .option-block { padding:15px; border:1px solid #ddd; border-radius:6px; background:#fafafa; margin-bottom:14px; }
    .row { margin-bottom:14px; }
    .row label { font-weight:bold; display:block; margin-bottom:6px; }

    .option-buttons button{
      padding:8px 12px; margin:4px;
      border:1px solid #aaa; border-radius:4px;
      background:#fff; cursor:pointer;
      transition: background .15s, color .15s, border-color .15s;
    }
    .option-buttons button.selected{ background:#007bff; color:#fff; border-color:#007bff; }

    .status { padding:10px; border:1px solid #ddd; border-radius:6px; background:#fff; }
    .muted { color:#666; }

    .pill { display:inline-block; padding:3px 8px; border:1px solid #ddd; border-radius:999px; margin:2px; background:#f8f8f8; }

    /* --- Table formatting --- */
    .sc-table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      background: #fff;
      font-size: 14px;
    }
    .sc-table th, .sc-table td {
      border: 2px solid #000;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
    }
    .sc-table thead th { font-weight: 700; }
    .sc-table .left-head { width: 220px; text-align:left; }
    .sc-table .left-cell { text-align:left; font-weight:700; }
    .sc-table .subhead { font-weight: 700; }
  </style>
</head>

<body>

<h2>NZ Address & Site Parameter Tool</h2>

<div class="search-wrap">
  <input id="addressInput" placeholder="Search address (NZ only)" />
  <button id="useMyLocationBtn" type="button">Use my location</button>
</div>

<div id="map"></div>
<div id="coords">Choose a location (search or click the map)</div>

<div class="option-block">
  <h3>Design Parameters</h3>

  <!-- Site Class (I..VI) -->
  <div class="row">
    <label>Site Class</label>
    <div class="option-buttons" id="siteClassOptions">
      <button type="button" data-value="I">I</button>
      <button type="button" data-value="II">II</button>
      <button type="button" data-value="III">III</button>
      <button type="button" data-value="IV">IV</button>
      <button type="button" data-value="V">V</button>
      <button type="button" data-value="VI">VI</button>
    </div>
  </div>

  <!-- Importance level (1..4) -->
  <div class="row">
    <label>Importance Level</label>
    <div class="option-buttons" id="importanceLevelOptions">
      <button type="button" data-value="1">1</button>
      <button type="button" data-value="2">2</button>
      <button type="button" data-value="3">3</button>
      <button type="button" data-value="4">4</button>
    </div>
  </div>

  <!-- Working life -->
  <div class="row">
    <label>Design Working Life</label>
    <div class="option-buttons" id="workingLifeOptions">
      <button type="button" data-value="construction">Construction equipment</button>
      <button type="button" data-value="lt6months">Less than 6 months</button>
      <button type="button" data-value="5">5 years</button>
      <button type="button" data-value="25">25 years</button>
      <button type="button" data-value="50">50 years</button>
      <button type="button" data-value="100">100 years or more</button>
    </div>
  </div>
</div>

<div class="status">
  <div><strong>Status:</strong> <span id="statusText">Waiting for input…</span></div>
  <div id="roundedCoordsBar" class="muted"></div>
  <div id="stepInfo" class="muted"></div>
  <div id="results"></div>
</div>

<script>
  /**************************************************************
   * CONFIG
   **************************************************************/
  const SHEET_ID = "1f34jZQUy7Jw4BZOP8xwj6DgXXvwDPnxbGhGkhUadULg";
  const SHEET1_NAME = "Sheet1";
  const SHEET2_NAME = "Sheet2";

  // Sheet1: A=Lat, B=Lng, C=APOE
  const SHEET1_LAT_COL_INDEX = 0;
  const SHEET1_LNG_COL_INDEX = 1;
  const SHEET1_APOE_COL_INDEX = 2;

  // Site class column indices in Sheet1
  const SHEET1_SITECLASS_COLS = {
    I:   { PGA: 3,  Sa: 4,  Tc: 5  },
    II:  { PGA: 6,  Sa: 7,  Tc: 8  },
    III: { PGA: 9,  Sa: 10, Tc: 11 },
    IV:  { PGA: 12, Sa: 13, Tc: 14 },
    V:   { PGA: 15, Sa: 16, Tc: 17 },
    VI:  { PGA: 18, Sa: 19, Tc: 20 },
  };

  // Sheet2: A=WorkingLife, B=ImportanceLevel, C/D/E strings
  const SHEET2_WORKINGLIFE_COL_INDEX = 0;
  const SHEET2_IMPORTANCE_COL_INDEX  = 1;
  const SHEET2_STRING_COLS = [2, 3, 4]; // C, D, E

  // Option B mapping (UI codes -> Sheet2 labels)
  const WORKING_LIFE_LABEL = {
    construction: "Construction equipment",
    lt6months: "Less than 6 months",
    "5": "5 years",
    "25": "25 years",
    "50": "50 years",
    "100": "100 years or more"
  };

  /**************************************************************
   * STATE
   **************************************************************/
  let map, marker, autocomplete;
  let selectedLat = null, selectedLng = null;

  let selectedSiteClass = "";
  let selectedImportanceLevel = "";
  let selectedWorkingLife = "";

  let matchedSheet1Rows = [];     // rows matching 1dp lat/lng
  let sheet2MatchOptions = [];    // [{title,value}] from matched Sheet2 row

  /**************************************************************
   * HELPERS
   **************************************************************/
  function setStatus(msg){ document.getElementById("statusText").textContent = msg; }
  function setInfo(html){ document.getElementById("stepInfo").innerHTML = html || ""; }

  function normalize(v){
    if (v === null || v === undefined) return "";
    return String(v).trim();
  }

  function eqLoose(a, b){
    const sa = normalize(a);
    const sb = normalize(b);
    if (sa === sb) return true;
    const na = Number(sa), nb = Number(sb);
    if (!Number.isNaN(na) && !Number.isNaN(nb) && na === nb) return true;
    return sa.toLowerCase() === sb.toLowerCase();
  }

  function safeCell(v) {
    if (v === null || v === undefined || String(v).trim() === "") return "";
    const n = Number(v);
    return Number.isFinite(n) ? (Math.round(n * 100) / 100).toString() : String(v);
  }

  function round1(n){
    const num = Number(n);
    if (!Number.isFinite(num)) return null;
    return Math.round(num * 10) / 10;
  }

  function setRoundedBar(){
    const el = document.getElementById("roundedCoordsBar");
    if (!Number.isFinite(selectedLat) || !Number.isFinite(selectedLng)) {
      el.textContent = "";
      return;
    }
    const rLat = round1(selectedLat);
    const rLng = round1(selectedLng);
    el.innerHTML = `Rounded (1dp) match key: <b>${rLat.toFixed(1)}, ${rLng.toFixed(1)}</b>`;
  }

  function setMarker(lat,lng){
    const pos = {lat, lng};
    if(marker) marker.setMap(null);
    marker = new google.maps.Marker({ map, position: pos });
    map.panTo(pos);
  }

  /**************************************************************
   * GOOGLE SHEETS (GVIZ)
   **************************************************************/
  function gvizUrl(sheetName, query){
    const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
    const params = new URLSearchParams();
    params.set("sheet", sheetName);
    params.set("tq", query);
    return `${base}?${params.toString()}`;
  }

  async function fetchSheetAs2DArray(sheetName, query){
    const url = gvizUrl(sheetName, query);
    const res = await fetch(url);
    const text = await res.text();
    const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    const data = JSON.parse(jsonText);

    const cols = data.table.cols.length;
    const rows = data.table.rows || [];

    return rows.map(r => {
      const arr = new Array(cols).fill(null);
      (r.c || []).forEach((cell, i) => { arr[i] = cell ? cell.v : null; });
      return arr;
    });
  }

  /**************************************************************
   * STEP 1: Match ALL rows in Sheet1 where (lat,lng) match to 1dp
   **************************************************************/
  async function step1_findAllSheet1RowsMatching1dp(){
    matchedSheet1Rows = [];
    if (!Number.isFinite(selectedLat) || !Number.isFinite(selectedLng)) return;

    setRoundedBar();
    setStatus("Step 1: Matching Sheet1 rows by lat/lng to 1 decimal point…");

    const rows = await fetchSheetAs2DArray(SHEET1_NAME, "select *");
    if (!rows.length) {
      setStatus("No rows found in Sheet1 (check sharing/tab name).");
      return;
    }

    const targetLat1 = round1(selectedLat);
    const targetLng1 = round1(selectedLng);

    for (const row of rows) {
      const lat = parseFloat(row[SHEET1_LAT_COL_INDEX]);
      const lng = parseFloat(row[SHEET1_LNG_COL_INDEX]);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

      if (round1(lat) === targetLat1 && round1(lng) === targetLng1) {
        matchedSheet1Rows.push({ row });
      }
    }

    setStatus(`Step 1 complete. Found ${matchedSheet1Rows.length} Sheet1 row(s) matching ${targetLat1.toFixed(1)}, ${targetLng1.toFixed(1)}.`);
  }

  /**************************************************************
   * STEP 2: Find matching Sheet2 row and capture:
   * - titles from header row C/D/E (if present)
   * - values from matched row C/D/E
   **************************************************************/
  async function step2_getTitlesAndStringsFromSheet2(){
    sheet2MatchOptions = [];

    i
