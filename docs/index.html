<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NZ Address & Site Parameter Tool</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }

    .search-wrap {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    #addressInput {
      width: min(650px, 100%);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #useMyLocationBtn {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #aaa;
      background: #fff;
      cursor: pointer;
    }

    #map {
      height: 420px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    #coords { font-weight: bold; margin-bottom: 12px; }

    .option-block {
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
      margin-bottom: 14px;
    }

    .row { margin-bottom: 14px; }

    .row label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }

    .option-buttons button {
      padding: 8px 12px;
      margin: 4px;
      border-radius: 4px;
      border: 1px solid #aaa;
      background: #fff;
      cursor: pointer;
    }

    .option-buttons button.selected {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    .status {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }

    th { background: #f3f3f3; }
    .muted { color: #666; }
  </style>
</head>

<body>

<h2>NZ Address & Site Parameter Tool</h2>

<!-- Address Search -->
<div class="search-wrap">
  <input id="addressInput" placeholder="Search address (NZ only)" />
  <button id="useMyLocationBtn">Use my location</button>
</div>

<div id="map"></div>
<div id="coords">Choose a location</div>

<!-- OPTIONS -->
<div class="option-block">
  <h3>Design Parameters</h3>

  <!-- SITE CLASS -->
  <div class="row">
    <label>Site Class</label>
    <div class="option-buttons" id="siteClassOptions">
      <button data-value="I">I</button>
      <button data-value="II">II</button>
      <button data-value="III">III</button>
      <button data-value="IV">IV</button>
      <button data-value="V">V</button>
      <button data-value="VI">VI</button>
    </div>
  </div>

  <!-- IMPORTANCE LEVEL -->
  <div class="row">
    <label>Importance Level</label>
    <div class="option-buttons" id="importanceLevelOptions">
      <button data-value="1">1</button>
      <button data-value="2">2</button>
      <button data-value="3">3</button>
      <button data-value="4">4</button>
    </div>
  </div>

  <!-- WORKING LIFE -->
  <div class="row">
    <label>Design Working Life</label>
    <div class="option-buttons" id="workingLifeOptions">
      <button data-value="construction">Construction equipment</button>
      <button data-value="lt6months">Less than 6 months</button>
      <button data-value="5">5 years</button>
      <button data-value="25">25 years</button>
      <button data-value="50">50 years</button>
      <button data-value="100">100 years or more</button>
    </div>
  </div>
</div>

<div class="status">
  <strong>Status:</strong> <span id="statusText">Waiting for inputâ€¦</span>
  <div id="matchInfo" class="muted"></div>
  <div id="results"></div>
</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "1f34jZQUy7Jw4BZOP8xwj6DgXXvwDPnxbGhGkhUadULg";
const SHEET1_NAME = "Sheet1";
const SHEET2_NAME = "Sheet2";

// Sheet1: A = LAT, B = LNG
const SHEET1_LAT_COL_INDEX = 0;
const SHEET1_LNG_COL_INDEX = 1;
const SHEET1_APOE_COL_INDEX = 2;

// Sheet2 column mapping (CHANGE IF NEEDED)
const SHEET2_WORKINGLIFE_COL_INDEX   = 0; // Column A
const SHEET2_SITECLASS_COL_INDEX     = 1; // Column B
const SHEET2_IMPORTANCELEVEL_COL_INDEX = 2; // Column C
const SHEET2_APOE_COLS = [3,4]; // Columns D, E

/* ================= STATE ================= */
let map, marker, autocomplete;
let selectedLat = null;
let selectedLng = null;
let selectedSiteClass = "";
let selectedImportanceLevel = "";
let selectedWorkingLife = "";
let matchedSheet1 = null;

/* ================= HELPERS ================= */
function normalize(v){ return v==null?"":String(v).trim(); }

function haversineKm(lat1,lng1,lat2,lng2){
  const R=6371,toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1),dLng=toRad(lng2-lng1);
  const a=Math.sin(dLat/2)**2+
          Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
          Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ================= SHEETS ================= */
function gviz(sheet,query){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheet}&tq=${encodeURIComponent(query)}`;
}

async function fetchSheet(sheet){
  const res=await fetch(gviz(sheet,"select *"));
  const text=await res.text();
  const json=JSON.parse(text.substring(text.indexOf("{"),text.lastIndexOf("}")+1));
  return (json.table.rows||[]).map(r=>r.c.map(c=>c?c.v:null));
}

/* ================= LOGIC ================= */
async function matchSheet1(){
  const rows=await fetchSheet(SHEET1_NAME);
  let best=null;

  for(const r of rows){
    const lat=parseFloat(r[SHEET1_LAT_COL_INDEX]);
    const lng=parseFloat(r[SHEET1_LNG_COL_INDEX]);
    if(!isFinite(lat)||!isFinite(lng)) continue;
    const d=haversineKm(selectedLat,selectedLng,lat,lng);
    if(!best||d<best.d) best={d,lat,lng,apoe:r[SHEET1_APOE_COL_INDEX]};
  }
  matchedSheet1=best;
}

async function filterSheet2(){
  if(!matchedSheet1||!selectedSiteClass||!selectedImportanceLevel||!selectedWorkingLife) return;

  const rows=await fetchSheet(SHEET2_NAME);
  const matches=rows.filter(r=>{
    if(normalize(r[SHEET2_SITECLASS_COL_INDEX])!==selectedSiteClass) return false;
    if(normalize(r[SHEET2_IMPORTANCELEVEL_COL_INDEX])!==selectedImportanceLevel) return false;
    if(normalize(r[SHEET2_WORKINGLIFE_COL_INDEX])!==selectedWorkingLife) return false;
    return SHEET2_APOE_COLS.some(i=>normalize(r[i])===normalize(matchedSheet1.apoe));
  });

  document.getElementById("results").innerHTML =
    matches.length
    ? `<pre>${JSON.stringify(matches,null,2)}</pre>`
    : `<div class="muted">No matches found</div>`;
}

/* ================= UI ================= */
function wireButtons(id,setter){
  document.querySelectorAll(`#${id} button`).forEach(b=>{
    b.onclick=async()=>{
      document.querySelectorAll(`#${id} button`).forEach(x=>x.classList.remove("selected"));
      b.classList.add("selected");
      setter(b.dataset.value);
      await matchSheet1();
      await filterSheet2();
    };
  });
}

/* ================= MAP ================= */
function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{
    center:{lat:-41.2865,lng:174.7762},zoom:6
  });

  map.addListener("click",async e=>{
    selectedLat=e.latLng.lat();
    selectedLng=e.latLng.lng();
    marker?.setMap(null);
    marker=new google.maps.Marker({map,position:e.latLng});
    await matchSheet1();
    await filterSheet2();
  });

  autocomplete=new google.maps.places.Autocomplete(
    document.getElementById("addressInput"),
    {componentRestrictions:{country:"nz"}}
  );

  autocomplete.addListener("place_changed",async()=>{
    const p=autocomplete.getPlace();
    if(!p.geometry) return;
    selectedLat=p.geometry.location.lat();
    selectedLng=p.geometry.location.lng();
    marker?.setMap(null);
    marker=new google.maps.Marker({map,position:p.geometry.location});
    map.setZoom(14);
    await matchSheet1();
    await filterSheet2();
  });

  wireButtons("siteClassOptions",v=>selectedSiteClass=v);
  wireButtons("importanceLevelOptions",v=>selectedImportanceLevel=v);
  wireButtons("workingLifeOptions",v=>selectedWorkingLife=v);
}

window.initMap=initMap;
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC671lrEe82CVe7kS6yCebRsF3GIGrOmLw&callback=initMap&libraries=places"
  async defer>
</script>

</body>
</html>
