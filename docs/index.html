<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TS1170.5 site parameter finder</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body { font-family: Arial, sans-serif; margin: 20px; }

    #pageTitle { text-align: center; margin: 0 0 16px 0; }

    /* Shared container aligns right edges of map/results/suggestions */
    .content-wrap{
      width: 100%;
      max-width: 1400px;  /* remove if you want full-bleed */
      margin: 0 auto;
    }

    /* Search row */
    .search-wrap { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; width:100%; }
    #addressInput { flex: 1 1 520px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; }
    #useMyLocationBtn { padding:10px; border:1px solid #aaa; border-radius:6px; background:#fff; cursor:pointer; }

    /* Coords sits ABOVE grid so it doesn't break option-block/map alignment */
    #coords { font-weight:bold; margin-bottom:12px; }

    /* Two-column */
    .main-grid { display:flex; gap:16px; align-items:stretch; width:100%; }
    .left-panel { flex: 0 0 520px; max-width: 520px; width:100%; }
    .right-panel { flex: 1 1 auto; min-width: 320px; display:flex; }

    @media (max-width: 980px){
      .main-grid { flex-direction: column; }
      .left-panel { max-width: 100%; flex-basis: auto; }
      .right-panel { width: 100%; }
    }

    .option-block{
      padding:15px;
      border:1px solid #ddd;
      border-radius:6px;
      background:#fafafa;
      width:100%;
    }
    .row { margin-bottom: 14px; }
    .row label { font-weight:bold; display:block; margin-bottom:6px; }

    .option-buttons button{
      padding:8px 12px;
      margin:4px;
      border:1px solid #aaa;
      border-radius:4px;
      background:#fff;
      cursor:pointer;
      transition: background .15s, color .15s, border-color .15s;
    }
    .option-buttons button.selected{
      background:#007bff;
      color:#fff;
      border-color:#007bff;
    }

    /* Map height is synced to option-block height via JS */
    #map{
      width:100%;
      min-height:280px;
      border:1px solid #ccc;
      border-radius:6px;
      flex: 1 1 auto;
    }

    /* Full-width results */
    .results-wrap{
      width: 100%;
      margin-top: 16px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      position: relative;
    }

    #roundedCoordsBar{
      display:none;
      font-weight:700;
      color:#666;
      margin-bottom: 10px;
    }

    #tablesGrid{
      display: grid;
      gap: 12px;
      width: 100%;
    }

    .table-card{
      width:100%;
      overflow-x:auto;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 8px;
      background: #fff;
    }

    .sc-table { width: 100%; border-collapse: collapse; background: #fff; font-size: 14px; }
    .sc-table th, .sc-table td { border: 2px solid #000; padding: 8px; text-align: center; vertical-align: middle; white-space: nowrap; }
    .sc-table thead th { font-weight: 700; }
    .sc-table .left-head { width: 220px; text-align:left; }
    .sc-table .left-cell { text-align:left; font-weight:700; }
    .sc-table .subhead { font-weight: 700; }

    /* Loading overlay - no pending calc text */
    .loading-overlay{
      position:absolute;
      inset:0;
      background: rgba(255,255,255,0.85);
      display:none;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      z-index: 2;
      font-weight: 700;
    }
    .loading-overlay.show{ display:flex; }

    /* Suggestions */
    .suggestions-wrap{
      margin-top: 18px;
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
      width: 100%;
    }
    #suggestionText{
      width: 100%;
      min-height: 110px;
      resize: vertical;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
    }
    #submitSuggestionBtn{
      display: inline-block;
      margin-top: 10px;
      padding: 10px 14px;
      border: 1px solid #aaa;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
    }
    #suggestionMsg{ margin-top: 8px; color:#666; }
  </style>
</head>

<body>
  <h2 id="pageTitle">TS1170.5 site parameter finder</h2>

  <div class="content-wrap">

    <div class="search-wrap">
      <input id="addressInput" placeholder="Search address (NZ only)" />
      <button id="useMyLocationBtn" type="button">Use my location</button>
    </div>

    <div id="coords">Choose a location (search or click the map)</div>

    <div class="main-grid">
      <div class="left-panel">
        <div class="option-block" id="designInputsBlock">
          <h3>Design Inputs</h3>

          <div class="row">
            <label>Site Class</label>
            <div class="option-buttons" id="siteClassOptions">
              <button type="button" data-value="I">I</button>
              <button type="button" data-value="II">II</button>
              <button type="button" data-value="III">III</button>
              <button type="button" data-value="IV">IV</button>
              <button type="button" data-value="V">V</button>
              <button type="button" data-value="VI">VI</button>
            </div>
          </div>

          <div class="row">
            <label>Importance Level</label>
            <div class="option-buttons" id="importanceLevelOptions">
              <button type="button" data-value="1">1</button>
              <button type="button" data-value="2">2</button>
              <button type="button" data-value="3">3</button>
              <button type="button" data-value="4">4</button>
            </div>
          </div>

          <div class="row" style="margin-bottom:0;">
            <label>Design Working Life</label>
            <div class="option-buttons" id="workingLifeOptions">
              <button type="button" data-value="construction">Construction equipment</button>
              <button type="button" data-value="lt6months">Less than 6 months</button>
              <button type="button" data-value="5">5 years</button>
              <button type="button" data-value="25">25 years</button>
              <button type="button" data-value="50">50 years</button>
              <button type="button" data-value="100">100 years or more</button>
            </div>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <div id="map"></div>
      </div>
    </div>

    <!-- Results -->
    <div class="results-wrap">
      <div class="loading-overlay" id="loadingOverlay">Loading…</div>
      <div id="roundedCoordsBar"></div>
      <div id="tablesGrid"></div>
    </div>

    <!-- Suggestions -->
    <div class="suggestions-wrap">
      <div style="font-weight:700; margin-bottom:8px;">Suggestions</div>
      <textarea id="suggestionText" placeholder="Got an idea to improve this tool? Drop it here…"></textarea>
      <div>
        <button id="submitSuggestionBtn" type="button">Submit</button>
      </div>
      <div id="suggestionMsg"></div>
    </div>

  </div>

  <!-- =========================================================
    CSP-SAFE ANALYTICS MODULE (kept)
  ========================================================= -->
  <script>
    window.WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwdt0bDi9pPJ6iyXwg11ItonXmCZOj40KYOyp71srRBFf9fcCYkdHxyV_4rhP1IGVgO/exec";
    window.GEO_URL = "/geo";
    window.ANALYTICS_DEBUG = false;

    (function () {
      var VISITOR_KEY = "nz_tool_visitor_id";

      function getVisitor() {
        var id = localStorage.getItem(VISITOR_KEY);
        var isNew = false;
        if (!id) {
          isNew = true;
          id = (window.crypto && crypto.randomUUID)
            ? ("v_" + crypto.randomUUID())
            : ("v_" + Date.now() + "_" + Math.random().toString(16).slice(2));
          localStorage.setItem(VISITOR_KEY, id);
        }
        return { id: id, isNew: isNew };
      }

      function safeGeoObject(g) {
        return {
          geoProvider: (g && g.geoProvider) ? g.geoProvider : "cloudflare",
          geoCountry: (g && g.geoCountry) ? g.geoCountry : "",
          geoRegion: (g && g.geoRegion) ? g.geoRegion : "",
          geoCity: (g && g.geoCity) ? g.geoCity : ""
        };
      }

      function getGeo() {
        var url = window.GEO_URL || "/geo";
        return fetch(url, { cache: "no-store" })
          .then(r => r.text().then(t => { try { return safeGeoObject(JSON.parse(t)); } catch(e){ return safeGeoObject(null); } }))
          .catch(() => safeGeoObject(null));
      }

      function postToAppsScript(payloadObj) {
        var url = window.WEB_APP_URL;
        var body = new URLSearchParams();
        body.set("payload", JSON.stringify(payloadObj));
        return fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: body.toString()
        }).then(res => res.text());
      }

      function logEvent(eventName, extra) {
        extra = extra || {};
        var v = getVisitor();
        return getGeo().then(function (geo) {
          var payload = Object.assign({
            visitorId: v.id,
            isNew: v.isNew,
            event: String(
