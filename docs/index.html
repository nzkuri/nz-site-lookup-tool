<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NZ Address & Site Parameter Tool</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }

    .search-wrap { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    #addressInput { width:min(650px,100%); padding:10px; border:1px solid #ccc; border-radius:6px; }
    #useMyLocationBtn { padding:10px; border:1px solid #aaa; border-radius:6px; background:#fff; cursor:pointer; }

    #map { height: 420px; width: 100%; border:1px solid #ccc; border-radius:6px; margin-bottom:12px; }
    #coords { font-weight: bold; margin-bottom: 12px; }

    .option-block { padding:15px; border:1px solid #ddd; border-radius:6px; background:#fafafa; margin-bottom:14px; }
    .row { margin-bottom:14px; }
    .row label { font-weight:bold; display:block; margin-bottom:6px; }

    .option-buttons button{
      padding:8px 12px; margin:4px;
      border:1px solid #aaa; border-radius:4px;
      background:#fff; cursor:pointer;
      transition: background .15s, color .15s, border-color .15s;
    }
    .option-buttons button.selected{ background:#007bff; color:#fff; border-color:#007bff; }

    .status { padding:10px; border:1px solid #ddd; border-radius:6px; background:#fff; }
    .muted { color:#666; }

    .pill { display:inline-block; padding:3px 8px; border:1px solid #ddd; border-radius:999px; margin:2px; background:#f8f8f8; }

    /* --- Table formatting like your screenshot --- */
    .sc-table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      background: #fff;
      font-size: 14px;
    }
    .sc-table th, .sc-table td {
      border: 2px solid #000;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
    }
    .sc-table thead th { font-weight: 700; }
    .sc-table .left-head { width: 220px; text-align:left; }
    .sc-table .subhead { font-weight: 700; }
    .sc-table .left-cell { text-align:left; font-weight:700; }
    .sc-table .left-cell.muted-left { font-weight:700; text-transform:lowercase; }
  </style>
</head>

<body>

<h2>NZ Address & Site Parameter Tool</h2>

<div class="search-wrap">
  <input id="addressInput" placeholder="Search address (NZ only)" />
  <button id="useMyLocationBtn" type="button">Use my location</button>
</div>

<div id="map"></div>
<div id="coords">Choose a location (search or click the map)</div>

<div class="option-block">
  <h3>Design Parameters</h3>

  <!-- Site Class (I..VI) -->
  <div class="row">
    <label>Site Class</label>
    <div class="option-buttons" id="siteClassOptions">
      <button type="button" data-value="I">I</button>
      <button type="button" data-value="II">II</button>
      <button type="button" data-value="III">III</button>
      <button type="button" data-value="IV">IV</button>
      <button type="button" data-value="V">V</button>
      <button type="button" data-value="VI">VI</button>
    </div>
  </div>

  <!-- Importance level (1..4) -->
  <div class="row">
    <label>Importance Level</label>
    <div class="option-buttons" id="importanceLevelOptions">
      <button type="button" data-value="1">1</button>
      <button type="button" data-value="2">2</button>
      <button type="button" data-value="3">3</button>
      <button type="button" data-value="4">4</button>
    </div>
  </div>

  <!-- Working life -->
  <div class="row">
    <label>Design Working Life</label>
    <div class="option-buttons" id="workingLifeOptions">
      <button type="button" data-value="construction">Construction equipment</button>
      <button type="button" data-value="lt6months">Less than 6 months</button>
      <button type="button" data-value="5">5 years</button>
      <button type="button" data-value="25">25 years</button>
      <button type="button" data-value="50">50 years</button>
      <button type="button" data-value="100">100 years or more</button>
    </div>
  </div>
</div>

<div class="status">
  <div><strong>Status:</strong> <span id="statusText">Waiting for input…</span></div>
  <div id="roundedCoordsBar" class="muted"></div>
  <div id="stepInfo" class="muted"></div>
  <div id="results"></div>
</div>

<script>
  /**************************************************************
   * CONFIG (EDIT THESE)
   **************************************************************/
  const SHEET_ID = "1f34jZQUy7Jw4BZOP8xwj6DgXXvwDPnxbGhGkhUadULg";
  const SHEET1_NAME = "Sheet1";
  const SHEET2_NAME = "Sheet2";

  // Sheet1: Column A = Lat, Column B = Lng, Column C = APOE
  const SHEET1_LAT_COL_INDEX = 0; // A
  const SHEET1_LNG_COL_INDEX = 1; // B
  const SHEET1_APOE_COL_INDEX = 2; // C

  // Update these indices if your Sheet1 changes
  const SHEET1_SITECLASS_COLS = {
    I:   { PGA: 3,  Sa: 4,  Tc: 5  },
    II:  { PGA: 6,  Sa: 7,  Tc: 8  },
    III: { PGA: 9,  Sa: 10, Tc: 11 },
    IV:  { PGA: 12, Sa: 13, Tc: 14 },
    V:   { PGA: 15, Sa: 16, Tc: 17 },
    VI:  { PGA: 18, Sa: 19, Tc: 20 },
  };

  // Sheet2:
  // A = WorkingLife, B = ImportanceLevel, C/D/E = strings used to filter Sheet1 APOE
  const SHEET2_WORKINGLIFE_COL_INDEX = 0; // A
  const SHEET2_IMPORTANCE_COL_INDEX  = 1; // B
  const SHEET2_STRING_COLS = [2, 3, 4];   // C, D, E

  /**************************************************************
   * OPTION B: Map UI codes -> Sheet2 labels
   **************************************************************/
  const WORKING_LIFE_LABEL = {
    construction: "Construction equipment",
    lt6months: "Less than 6 months",
    "5": "5 years",
    "25": "25 years",
    "50": "50 years",
    "100": "100 years or more"
  };

  /**************************************************************
   * STATE
   **************************************************************/
  let map, marker, autocomplete;
  let selectedLat = null, selectedLng = null;

  let selectedSiteClass = "";
  let selectedImportanceLevel = "";
  let selectedWorkingLife = "";

  // ALL Sheet1 rows matching rounded lat/lng (1dp)
  let matchedSheet1Rows = []; // [{lat,lng,apoe,row}]

  // From the matched Sheet2 row: array like [{colIndex, title, value}]
  let sheet2MatchOptions = []; // titles from header row (C/D/E) + values from matched row

  /**************************************************************
   * HELPERS
   **************************************************************/
  function setStatus(msg){ document.getElementById("statusText").textContent = msg; }
  function setInfo(html){ document.getElementById("stepInfo").innerHTML = html || ""; }

  function normalize(v){
    if (v === null || v === undefined) return "";
    return String(v).trim();
  }

  function eqLoose(a, b){
    const sa = normalize(a);
    const sb = normalize(b);
    if (sa === sb) return true;
    const na = Number(sa), nb = Number(sb);
    if (!Number.isNaN(na) && !Number.isNaN(nb) && na === nb) return true;
    return sa.toLowerCase() === sb.toLowerCase();
  }

  function safeCell(v) {
    if (v === null || v === undefined || String(v).trim() === "") return "";
    const n = Number(v);
    return Number.isFinite(n) ? (Math.round(n * 100) / 100).toString() : String(v);
  }

  function round1(n){
    const num = Number(n);
    if (!Number.isFinite(num)) return null;
    return Math.round(num * 10) / 10;
  }

  function setRoundedBar(){
    const el = document.getElementById("roundedCoordsBar");
    if (!Number.isFinite(selectedLat) || !Number.isFinite(selectedLng)) {
      el.textContent = "";
      return;
    }
    const rLat = round1(selectedLat);
    const rLng = round1(selectedLng);
    el.innerHTML = `Rounded (1dp) match key: <b>${rLat.toFixed(1)}, ${rLng.toFixed(1)}</b>`;
  }

  function setMarker(lat,lng){
    const pos = {lat, lng};
    if(marker) marker.setMap(null);
    marker = new google.maps.Marker({ map, position: pos });
    map.panTo(pos);
  }

  /**************************************************************
   * GOOGLE SHEETS (GVIZ)
   **************************************************************/
  function gvizUrl(sheetName, query){
    const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
    const params = new URLSearchParams();
    params.set("sheet", sheetName);
    params.set("tq", query);
    return `${base}?${params.toString()}`;
  }

  async function fetchSheetAs2DArray(sheetName, query){
    const url = gvizUrl(sheetName, query);
    const res = await fetch(url);
    const text = await res.text();
    const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    const data = JSON.parse(jsonText);

    const cols = data.table.cols.length;
    const rows = data.table.rows || [];

    return rows.map(r => {
      const arr = new Array(cols).fill(null);
      (r.c || []).forEach((cell, i) => { arr[i] = cell ? cell.v : null; });
      return arr;
    });
  }

  /**************************************************************
   * STEP 1: Match ALL rows in Sheet1 where (lat,lng) match to 1dp
   **************************************************************/
  async function step1_findAllSheet1RowsMatching1dp(){
    matchedSheet1Rows = [];
    if (!Number.isFinite(selectedLat) || !Number.isFinite(selectedLng)) return;

    setRoundedBar();
    setStatus("Step 1: Matching Sheet1 rows by lat/lng to 1 decimal point…");

    const rows = await fetchSheetAs2DArray(SHEET1_NAME, "select *");
    if (!rows.length) {
      setStatus("No rows found in Sheet1 (check sharing/tab name).");
      return;
    }

    const targetLat1 = round1(selectedLat);
    const targetLng1 = round1(selectedLng);
    if (targetLat1 === null || targetLng1 === null) {
      setStatus("Invalid selected coordinates.");
      return;
    }

    for (const row of rows) {
      const lat = parseFloat(row[SHEET1_LAT_COL_INDEX]);
      const lng = parseFloat(row[SHEET1_LNG_COL_INDEX]);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

      if (round1(lat) === targetLat1 && round1(lng) === targetLng1) {
        matchedSheet1Rows.push({
          lat, lng,
          apoe: row[SHEET1_APOE_COL_INDEX],
          row
        });
      }
    }

    setStatus(`Step 1 complete. Found ${matchedSheet1Rows.length} Sheet1 row(s) matching ${targetLat1.toFixed(1)}, ${targetLng1.toFixed(1)}.`);
  }

  /**************************************************************
   * STEP 2: match Sheet2 A&B, collect titles+strings from C/D/E
   * - Titles: take from header row C/D/E if a header row exists.
   * - Values: take from the matched option row C/D/E.
   **************************************************************/
  async function step2_getTitlesAndStringsFromSheet2(){
    sheet2MatchOptions = [];

    if (!selectedWorkingLife || !selectedImportanceLevel) return;

    setStatus("Step 2: Looking up selected options in Sheet2…");

    const sheet2 = await fetchSheetAs2DArray(SHEET2_NAME, "select A,B,C,D,E");
    if (!sheet2.length) {
      setStatus("Sheet2 empty / not accessible.");
      return;
    }

    // Detect header row
    const firstA = normalize(sheet2[0][SHEET2_WORKINGLIFE_COL_INDEX]).toLowerCase();
    const firstB = normalize(sheet2[0][SHEET2_IMPORTANCE_COL_INDEX]).toLowerCase();
    const headerish = firstA.includes("working") || firstB.includes("importance");

    const headerRow = headerish ? sheet2[0] : null;
    const dataRows = headerish ? sheet2.slice(1) : sheet2;

    const workingLifeForMatch = WORKING_LIFE_LABEL[selectedWorkingLife] || selectedWorkingLife;

    const matchRow = dataRows.find(r =>
      eqLoose(r[SHEET2_WORKINGLIFE_COL_INDEX], workingLifeForMatch) &&
      eqLoose(r[SHEET2_IMPORTANCE_COL_INDEX], selectedImportanceLevel)
    );

    if (!matchRow) {
      sheet2MatchOptions = [];
      setStatus("No matching row in Sheet2 for selected options.");
      return;
    }

    // Build [{title,value}] for C/D/E
    sheet2MatchOptions = SHEET2_STRING_COLS
      .map((colIdx, k) => {
        const title = headerRow ? normalize(headerRow[colIdx]) : ["C","D","E"][k];
        const value = normalize(matchRow[colIdx]);
        return { colIndex: colIdx, title: title || ["C","D","E"][k], value };
      })
      .filter(x => x.value.length > 0);

    setStatus("Step 2 complete.");
  }

  /**************************************************************
   * STEP 3: Keep only Sheet1 rows where APOE matches any Sheet2 C/D/E,
   * and attach which Sheet2 cell matched (title + value).
   **************************************************************/
  function step3_filterMatchedSheet1Rows(){
    if (!matchedSheet1Rows.length) return [];
    if (!sheet2MatchOptions.length) return [];

    return matchedSheet1Rows
      .map(item => {
        const apoe = normalize(item.apoe);
        if (!apoe) return null;

        const match = sheet2MatchOptions.find(opt => opt.value.toLowerCase() === apoe.toLowerCase());
        if (!match) return null;

        return {
          ...item,
          matchTitle: match.title,
          matchString: match.value
        };
      })
      .filter(Boolean);
  }

  /**************************************************************
   * TABLE RENDER (ONLY selected site class column group)
   *
   * Requirements you asked for:
   * - Top-left (first row/first column): Sheet2 title (from C/D/E header)
   * - Second row/first column: text "apoe"
   * - Last row/first column: the matching Sheet2 string (C/D/E)
   * - Only show the columns for the selected Site Class
   **************************************************************/
  function buildSiteClassTableFromMatch(sheet1Row, matchTitle, apoeValue, matchString){
    const sc = selectedSiteClass;
    const idx = SHEET1_SITECLASS_COLS[sc];

    const pga = idx ? safeCell(sheet1Row[idx.PGA]) : "";
    const sa  = idx ? safeCell(sheet1Row[idx.Sa])  : "";
    const tc  = idx ? safeCell(sheet1Row[idx.Tc])  : "";

    const topLeft = matchTitle || "(Sheet2 title blank)";
    const apoe = apoeValue || "(APOE blank)";
    const mStr = matchString || "(Sheet2 string blank)";

    return `
      <table class="sc-table">
        <thead>
          <tr>
            <th class="left-head">${topLeft}</th>
            <th colspan="3">Site Class ${sc}</th>
          </tr>
          <tr>
            <th class="subhead left-cell muted-left">apoe</th>
            <th class="subhead">PGA</th>
            <th class="subhead">Sa,s</th>
            <th class="subhead">Tc</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="left-cell">${apoe}</td>
            <td>${pga}</td>
            <td>${sa}</td>
            <td>${tc}</td>
          </tr>
          <tr>
            <td class="left-cell">${mStr}</td>
            <td colspan="3"></td>
          </tr>
        </tbody>
      </table>
    `;
  }

  /**************************************************************
   * RENDER OUTPUT
   **************************************************************/
  function render(filtered){
    const resultsEl = document.getElementById("results");

    const infoBits = [];
    if (Number.isFinite(selectedLat) && Number.isFinite(selectedLng)) {
      const tLat1 = round1(selectedLat);
      const tLng1 = round1(selectedLng);
      infoBits.push(`Location: <b>${selectedLat.toFixed(5)}, ${selectedLng.toFixed(5)}</b>`);
      infoBits.push(`<span class="muted">Matching bucket (1dp): ${tLat1.toFixed(1)}, ${tLng1.toFixed(1)}</span>`);
    }

    if (selectedSiteClass) infoBits.push(`Site Class: <b>${selectedSiteClass}</b>`);
    if (selectedWorkingLife) {
      const wlLabel = WORKING_LIFE_LABEL[selectedWorkingLife] || selectedWorkingLife;
      infoBits.push(`Working Life: <b>${selectedWorkingLife}</b> <span class="muted">(matches Sheet2 as "${wlLabel}")</span>`);
    }
    if (selectedImportanceLevel) infoBits.push(`Importance: <b>${selectedImportanceLevel}</b>`);

    if (sheet2MatchOptions.length) {
      infoBits.push(
        `Sheet2 (C/D/E): ` +
        sheet2MatchOptions.map(o => `<span class="pill"><b>${o.title}:</b> ${o.value}</span>`).join("")
      );
    } else if (selectedWorkingLife && selectedImportanceLevel) {
      infoBits.push(`<span class="muted">Sheet2 (C/D/E): (none found)</span>`);
    }

    infoBits.push(`<span class="muted">Sheet1 rows matched to 1dp: ${matchedSheet1Rows.length}</span>`);
    setInfo(infoBits.join("<br>"));

    if (!Number.isFinite(selectedLat) || !Number.isFinite(selectedLng)) {
      resultsEl.innerHTML = `<div class="muted">Pick a location first.</div>`;
      return;
    }
    if (!selectedSiteClass) {
      resultsEl.innerHTML = `<div class="muted">Select Site Class.</div>`;
      return;
    }
    if (!selectedWorkingLife || !selectedImportanceLevel) {
      resultsEl.innerHTML = `<div class="muted">Select Working Life and Importance Level.</div>`;
      return;
    }
    if (!sheet2MatchOptions.length) {
      resultsEl.innerHTML = `<div class="muted">No Sheet2 strings found for that selection (check Sheet2 A/B values and the working-life mapping).</div>`;
      return;
    }
    if (!matchedSheet1Rows.length) {
      resultsEl.innerHTML = `<div><strong>No Sheet1 rows matched</strong></div>
        <div class="muted">No rows in Sheet1 had lat/lng matching your selected location rounded to 1 decimal point.</div>`;
      return;
    }
    if (!filtered.length) {
      resultsEl.innerHTML = `<div><strong>No matches found</strong></div>
        <div class="muted">Rows matched the 1dp lat/lng bucket, but none had APOE matching Sheet2 C/D/E strings.</div>`;
      return;
    }

    resultsEl.innerHTML = filtered
      .map(item => buildSiteClassTableFromMatch(item.row, item.matchTitle, normalize(item.apoe), item.matchString))
      .join("");
  }

  async function recalc(){
    try {
      setRoundedBar();

      await step1_findAllSheet1RowsMatching1dp();
      await step2_getTitlesAndStringsFromSheet2();

      const filtered = step3_filterMatchedSheet1Rows();

      setStatus("Done.");
      render(filtered);
    } catch (err) {
      console.error(err);
      setStatus("Error (check console).");
      document.getElementById("results").innerHTML = `<div class="muted">Error occurred. See console.</div>`;
    }
  }

  /**************************************************************
   * BUTTON WIRING
   **************************************************************/
  function wireSingleSelectButtons(containerId, setter){
    const buttons = document.querySelectorAll(`#${containerId} button`);
    buttons.forEach(btn => {
      btn.addEventListener("click", async () => {
        buttons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        setter(btn.dataset.value);
        await recalc();
      });
    });
  }

  /**************************************************************
   * MAP + AUTOCOMPLETE
   **************************************************************/
  function initMap(){
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: -41.2865, lng: 174.7762 },
      zoom: 6
    });

    map.addListener("click", async (e) => {
      selectedLat = e.latLng.lat();
      selectedLng = e.latLng.lng();
      setMarker(selectedLat, selectedLng);

      document.getElementById("coords").textContent =
        `Lat: ${selectedLat.toFixed(5)}, Lng: ${selectedLng.toFixed(5)}`;

      setRoundedBar();
      await recalc();
    });

    autocomplete = new google.maps.places.Autocomplete(
      document.getElementById("addressInput"),
      { componentRestrictions: { country: "nz" } }
    );

    autocomplete.addListener("place_changed", async () => {
      const place = autocomplete.getPlace();
      if (!place.geometry || !place.geometry.location) {
        setStatus("No geometry for that address. Try another.");
        return;
      }

      selectedLat = place.geometry.location.lat();
      selectedLng = place.geometry.location.lng();
      setMarker(selectedLat, selectedLng);
      map.setZoom(14);

      document.getElementById("coords").textContent =
        `Lat: ${selectedLat.toFixed(5)}, Lng: ${selectedLng.toFixed(5)} — ${place.formatted_address || ""}`;

      setRoundedBar();
      await recalc();
    });

    document.getElementById("useMyLocationBtn").addEventListener("click", () => {
      if (!navigator.geolocation) {
        setStatus("Geolocation not supported.");
        return;
      }
      navigator.geolocation.getCurrentPosition(async (pos) => {
        selectedLat = pos.coords.latitude;
        selectedLng = pos.coords.longitude;
        setMarker(selectedLat, selectedLng);
        map.setZoom(14);

        document.getElementById("coords").textContent =
          `Lat: ${selectedLat.toFixed(5)}, Lng: ${selectedLng.toFixed(5)}`;

        setRoundedBar();
        await recalc();
      }, () => setStatus("Could not get your location (permission denied?)."));
    });

    wireSingleSelectButtons("siteClassOptions", v => selectedSiteClass = v);
    wireSingleSelectButtons("importanceLevelOptions", v => selectedImportanceLevel = v);
    wireSingleSelectButtons("workingLifeOptions", v => selectedWorkingLife = v);

    setStatus("Ready. Choose location + options.");
    setRoundedBar();
  }

  window.initMap = initMap;
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC671lrEe82CVe7kS6yCebRsF3GIGrOmLw&callback=initMap&libraries=places"
  async defer></script>

</body>
</html>
