<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analytics + Cloudflare Geo</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin: 12px 0; }
    button { padding: 10px 14px; cursor: pointer; }
    input, select { padding: 8px; }
    .small { opacity: .75; font-size: 12px; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow: auto; }
  </style>
</head>

<body>
  <h1>Site Tool</h1>
  <p class="small">
    This page demonstrates logging analytics to Google Apps Script and retrieving estimated visitor geo
    via a Cloudflare Worker at <code>/geo</code>.
  </p>

  <div class="row">
    <button id="btnPageView">Log Pageview</button>
    <button id="btnTest">Log Test Event</button>
  </div>

  <div class="row">
    <label>
      Site Class
      <select id="siteClass">
        <option value="">--</option>
        <option value="I">I</option>
        <option value="II">II</option>
        <option value="III">III</option>
        <option value="IV">IV</option>
        <option value="V">V</option>
        <option value="VI">VI</option>
      </select>
    </label>

    <label>
      Importance Level
      <select id="importanceLevel">
        <option value="">--</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </label>

    <label>
      Working Life
      <select id="workingLife">
        <option value="">--</option>
        <option value="Construction equipment">Construction equipment</option>
        <option value="Less than 6 months">Less than 6 months</option>
        <option value="5 years">5 years</option>
        <option value="25 years">25 years</option>
        <option value="50 years">50 years</option>
        <option value="100 years or more">100 years or more</option>
      </select>
    </label>
  </div>

  <div class="row">
    <label>
      Analytics
      <select id="analyticsOpt">
        <option value="on">On</option>
        <option value="off">Off</option>
      </select>
    </label>
  </div>

  <h3>Debug</h3>
  <pre id="debug">(events will appear here)</pre>

  <script>
    /***************************************************************
     * CONFIG — paste your Apps Script Web App URL here
     ***************************************************************/
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz2nZZdI6Klhn5Xx4a5AfkheAgRtN8oklYGM-sJl40ePQhS4u9V-mXyIizxdvtaI-ny/exec";

    /***************************************************************
     * SIMPLE OPT-OUT (localStorage) + Do Not Track
     ***************************************************************/
    const OPT_KEY = "analytics_opt"; // "on" | "off"

    function setOpt(value) {
      localStorage.setItem(OPT_KEY, value);
    }

    function getOpt() {
      return localStorage.getItem(OPT_KEY) || "on";
    }

    function analyticsAllowed() {
      const dnt = (navigator.doNotTrack === "1" || window.doNotTrack === "1");
      const opt = (getOpt() === "on");
      return opt && !dnt;
    }

    /***************************************************************
     * VISITOR ID (pseudonymous)
     ***************************************************************/
    const VID_KEY = "vid";

    function getVisitorId() {
      let vid = localStorage.getItem(VID_KEY);
      if (!vid) {
        vid = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
        localStorage.setItem(VID_KEY, vid);
      }
      return vid;
    }

    function isNewVisitor() {
      return !localStorage.getItem(VID_KEY);
    }

    /***************************************************************
     * GEO — fetch from Cloudflare Worker at /geo
     * Expected JSON:
     * { geoProvider, geoCountry, geoRegion, geoCity, estLat?, estLng? }
     ***************************************************************/
    async function getGeo() {
      try {
        const r = await fetch("/geo", { method: "GET", cache: "no-store" });
        if (!r.ok) throw new Error("geo_failed");
        const g = await r.json();

        // Keep only coarse fields for analytics (NZ-friendly default)
        return {
          geoProvider: (g.geoProvider || "cloudflare"),
          geoCountry: (g.geoCountry || ""),
          geoRegion:  (g.geoRegion  || ""),
          geoCity:    (g.geoCity    || ""),

          // Optional; keep blank if you want ultra-minimal
          estLat: (g.estLat ?? ""),
          estLng: (g.estLng ?? "")
        };
      } catch (e) {
        return {
          geoProvider: "none",
          geoCountry: "",
          geoRegion: "",
          geoCity: "",
          estLat: "",
          estLng: ""
        };
      }
    }

    /***************************************************************
     * TIME ON PAGE (simple)
     ***************************************************************/
    const pageStart = Date.now();
    function timeOnPageSeconds() {
      return Math.max(0, Math.round((Date.now() - pageStart) / 1000));
    }

    /***************************************************************
     * LOGGER — sends to Apps Script
     ***************************************************************/
    function n(v) {
      return (v === null || v === undefined) ? "" : String(v).trim();
    }

    async function logEvent(payload) {
      if (!analyticsAllowed()) {
        debug("Analytics disabled (opt-out or DNT). Not logging.");
        return;
      }
      if (!WEB_APP_URL || WEB_APP_URL.includes("PASTE_YOUR")) {
        debug("ERROR: Set WEB_APP_URL at top of the script.");
        return;
      }

      const geo = await getGeo();

      const body = {
        // required / common fields
        visitorId: getVisitorId(),
        isNew: payload.isNew === true,
        event: n(payload.event),
        page: n(payload.page || location.pathname),

        // your existing fields
        roundedLatLng: n(payload.roundedLatLng),
        siteClass: n(payload.siteClass),
        importanceLevel: n(payload.importanceLevel),
        workingLife: n(payload.workingLife),
        buttonType: n(payload.buttonType),
        buttonValue: n(payload.buttonValue),
        timeOnPageSeconds: n(payload.timeOnPageSeconds ?? timeOnPageSeconds()),
        userAgent: navigator.userAgent,

        // geo fields (coarse + optional est lat/lng)
        geoCountry: n(geo.geoCountry),
        geoRegion: n(geo.geoRegion),
        geoCity: n(geo.geoCity),
        geoProvider: n(geo.geoProvider),
        estLat: n(geo.estLat),
        estLng: n(geo.estLng),

        // add anything else you want
        tsClient: new Date().toISOString()
      };

      debug("POST payload:\n" + JSON.stringify(body, null, 2));

      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const text = await res.text();
        debug("Response (" + res.status + "):\n" + text);
      } catch (err) {
        debug("POST failed:\n" + String(err));
      }
    }

    /***************************************************************
     * UI WIRING
     ***************************************************************/
    const debugEl = document.getElementById("debug");
    function debug(msg) {
      debugEl.textContent = msg;
    }

    // Opt-out control
    const analyticsOpt = document.getElementById("analyticsOpt");
    analyticsOpt.value = getOpt();
    analyticsOpt.addEventListener("change", () => {
      setOpt(analyticsOpt.value);
      debug("Analytics set to: " + analyticsOpt.value);
    });

    // Buttons
    document.getElementById("btnPageView").addEventListener("click", () => {
      logEvent({
        isNew: isNewVisitor(),
        event: "pageview",
        page: location.pathname,
        siteClass: document.getElementById("siteClass").value,
        importanceLevel: document.getElementById("importanceLevel").value,
        workingLife: document.getElementById("workingLife").value
      });
    });

    document.getElementById("btnTest").addEventListener("click", () => {
      logEvent({
        isNew: isNewVisitor(),
        event: "test_event",
        page: location.pathname,
        siteClass: document.getElementById("siteClass").value,
        importanceLevel: document.getElementById("importanceLevel").value,
        workingLife: document.getElementById("workingLife").value,
        buttonType: "test",
        buttonValue: "clicked"
      });
    });

    /***************************************************************
     * OPTIONAL: Auto-log a pageview on load
     * Uncomment if desired.
     ***************************************************************/
    // window.addEventListener("load", () => {
    //   logEvent({
    //     isNew: isNewVisitor(),
    //     event: "pageview_auto",
    //     page: location.pathname
    //   });
    // });
  </script>
</body>
</html>
